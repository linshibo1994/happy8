# 快乐8智能预测系统 - 部署指南

## 📋 目录

1. [系统要求](#系统要求)
2. [本地部署](#本地部署)
3. [Docker部署](#docker部署)
4. [云服务器部署](#云服务器部署)
5. [性能优化配置](#性能优化配置)
6. [监控和维护](#监控和维护)
7. [故障排除](#故障排除)

## 💻 系统要求

### 最低配置
- **操作系统**: Windows 10/macOS 10.15/Ubuntu 18.04+
- **Python**: 3.8+
- **CPU**: 4核心
- **内存**: 8GB RAM
- **存储**: 2GB可用空间
- **网络**: 稳定的互联网连接

### 推荐配置
- **操作系统**: Ubuntu 20.04 LTS / macOS 12+
- **Python**: 3.9+
- **CPU**: 8核心+ (Intel i7/AMD Ryzen 7)
- **内存**: 16GB+ RAM
- **存储**: 10GB+ SSD
- **GPU**: NVIDIA GTX 1060+ (可选，用于深度学习加速)
- **网络**: 100Mbps+

### 生产环境配置
- **CPU**: 16核心+ (Intel Xeon/AMD EPYC)
- **内存**: 32GB+ RAM
- **存储**: 50GB+ NVMe SSD
- **GPU**: NVIDIA RTX 3080+ / Tesla V100+
- **网络**: 1Gbps+ 专线

## 🏠 本地部署

### 1. 环境准备

```bash
# 1. 克隆项目
git clone https://github.com/linshibo1994/happy8.git
cd happy8

# 2. 创建虚拟环境
python3 -m venv venv
source venv/bin/activate  # Linux/macOS
# 或
venv\Scripts\activate     # Windows

# 3. 升级pip
pip install --upgrade pip

# 4. 安装依赖
pip install -r requirements.txt
```

### 2. 基础配置

```bash
# 1. 验证安装
python main.py --help

# 2. 测试数据加载
python main.py test-data

# 3. 运行系统测试
python src/system_test_suite.py
```

### 3. 启动服务

```bash
# Web界面模式
python main.py web

# 命令行模式
python main.py predict --issue 2025999 --method frequency --count 10
```

## 🐳 Docker部署

### 1. 创建Dockerfile

```dockerfile
FROM python:3.9-slim

WORKDIR /app

# 安装系统依赖
RUN apt-get update && apt-get install -y \
    gcc \
    g++ \
    && rm -rf /var/lib/apt/lists/*

# 复制项目文件
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

COPY . .

# 暴露端口
EXPOSE 8501

# 启动命令
CMD ["python", "main.py", "web"]
```

### 2. 构建和运行

```bash
# 构建镜像
docker build -t happy8-predictor .

# 运行容器
docker run -p 8501:8501 happy8-predictor

# 后台运行
docker run -d -p 8501:8501 --name happy8 happy8-predictor
```

### 3. Docker Compose部署

```yaml
version: '3.8'

services:
  happy8:
    build: .
    ports:
      - "8501:8501"
    environment:
      - PYTHONPATH=/app
    volumes:
      - ./data:/app/data
      - ./logs:/app/logs
    restart: unless-stopped
    
  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
    depends_on:
      - happy8
    restart: unless-stopped
```

## ☁️ 云服务器部署

### 1. AWS EC2部署

```bash
# 1. 启动EC2实例 (推荐: t3.large或更高)
# 2. 连接到实例
ssh -i your-key.pem ubuntu@your-ec2-ip

# 3. 更新系统
sudo apt update && sudo apt upgrade -y

# 4. 安装Python和Git
sudo apt install python3 python3-pip python3-venv git -y

# 5. 克隆项目
git clone https://github.com/linshibo1994/happy8.git
cd happy8

# 6. 安装依赖
python3 -m venv venv
source venv/bin/activate
pip install -r requirements.txt

# 7. 配置防火墙
sudo ufw allow 8501
sudo ufw enable

# 8. 启动服务
nohup python main.py web > app.log 2>&1 &
```

### 2. 阿里云ECS部署

```bash
# 1. 创建ECS实例 (推荐: ecs.c6.large或更高)
# 2. 配置安全组规则 (开放8501端口)
# 3. 连接服务器
ssh root@your-ecs-ip

# 4. 安装依赖
yum update -y
yum install python3 python3-pip git -y

# 5. 部署应用 (同AWS步骤5-8)
```

### 3. 使用Systemd管理服务

```bash
# 创建服务文件
sudo nano /etc/systemd/system/happy8.service
```

```ini
[Unit]
Description=Happy8 Prediction System
After=network.target

[Service]
Type=simple
User=ubuntu
WorkingDirectory=/home/ubuntu/happy8
Environment=PATH=/home/ubuntu/happy8/venv/bin
ExecStart=/home/ubuntu/happy8/venv/bin/python main.py web
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

```bash
# 启用和启动服务
sudo systemctl daemon-reload
sudo systemctl enable happy8
sudo systemctl start happy8

# 查看状态
sudo systemctl status happy8
```

## ⚡ 性能优化配置

### 1. CPU优化

```bash
# 设置CPU亲和性
taskset -c 0-7 python main.py web

# 调整进程优先级
nice -n -10 python main.py web
```

### 2. 内存优化

```python
# 在main.py中添加内存优化配置
import os
os.environ['OMP_NUM_THREADS'] = '8'
os.environ['MKL_NUM_THREADS'] = '8'
```

### 3. GPU加速配置

```bash
# 安装CUDA (如果有NVIDIA GPU)
wget https://developer.download.nvidia.com/compute/cuda/11.8/local_installers/cuda_11.8.0_520.61.05_linux.run
sudo sh cuda_11.8.0_520.61.05_linux.run

# 安装PyTorch GPU版本
pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu118
```

### 4. 网络优化

```bash
# 配置Nginx反向代理
upstream happy8_backend {
    server 127.0.0.1:8501;
}

server {
    listen 80;
    server_name your-domain.com;
    
    location / {
        proxy_pass http://happy8_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

## 📊 监控和维护

### 1. 日志配置

```python
# 在src/config.py中配置日志
import logging

logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    handlers=[
        logging.FileHandler('logs/app.log'),
        logging.StreamHandler()
    ]
)
```

### 2. 性能监控

```bash
# 安装监控工具
pip install psutil

# 创建监控脚本
python src/performance_optimizer.py
```

### 3. 健康检查

```bash
# 创建健康检查脚本
#!/bin/bash
curl -f http://localhost:8501/_stcore/health || exit 1
```

### 4. 自动备份

```bash
# 创建备份脚本
#!/bin/bash
DATE=$(date +%Y%m%d_%H%M%S)
tar -czf backup_$DATE.tar.gz data/ logs/ src/
```

## 🔧 故障排除

### 常见问题

#### 1. 端口被占用
```bash
# 查找占用端口的进程
lsof -i :8501
# 杀死进程
kill -9 PID
```

#### 2. 内存不足
```bash
# 查看内存使用
free -h
# 清理缓存
sudo sync && sudo sysctl vm.drop_caches=3
```

#### 3. 依赖包冲突
```bash
# 重新创建虚拟环境
rm -rf venv
python3 -m venv venv
source venv/bin/activate
pip install -r requirements.txt
```

#### 4. GPU不可用
```bash
# 检查CUDA安装
nvidia-smi
# 检查PyTorch GPU支持
python -c "import torch; print(torch.cuda.is_available())"
```

### 性能调优

#### 1. 算法选择优化
- 日常使用: frequency, adaptive_markov
- 高精度需求: super_predictor
- 快速响应: clustering, bayesian

#### 2. 资源分配优化
- CPU密集型算法: 分配更多CPU核心
- 内存密集型算法: 增加内存限制
- GPU算法: 确保GPU可用性

#### 3. 缓存策略
- 启用数据缓存
- 预加载常用模型
- 定期清理临时文件

---

## 📞 技术支持

如遇到部署问题，请：
1. 查看系统日志: `tail -f logs/app.log`
2. 运行系统测试: `python src/system_test_suite.py`
3. 检查系统资源: `python src/performance_optimizer.py`
4. 提交GitHub Issue并附上错误日志

**部署成功后，访问 http://your-server:8501 开始使用！** 🎉
